name: Build and Release

on:
  push:
    branches:
      - main
    tags:
      - "v*"

jobs:
  build:
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      # Determine version from tags
      - name: Determine version
        id: vars
        shell: bash
        run: |
          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            base_version="${GITHUB_REF#refs/tags/v}"
            version="$base_version"
            release_name="$base_version"
          else
            version="0.0.0-dev-$(date +%Y%m%d)"
            base_version="0.0.0-dev"
            release_name="$version"
          fi
          echo "version=$version" >> $GITHUB_OUTPUT
          echo "base_version=$base_version" >> $GITHUB_OUTPUT
          echo "release_name=$release_name" >> $GITHUB_OUTPUT

      # Verify icon files exist
      - name: Verify icon files
        shell: pwsh
        run: |
          Write-Host "=== Icon Files Check ==="
          if (Test-Path "./icon/icon.ico") {
            Write-Host "‚úì icon.ico found"
            $iconSize = (Get-Item "./icon/icon.ico").Length
            Write-Host "  Size: $iconSize bytes"
          } else {
            Write-Host "‚úó icon.ico NOT found"
            exit 1
          }
          
          Write-Host "`n=== Language Files Check ==="
          if (Test-Path "./language/lang_ko.ini") {
            Write-Host "‚úì lang_ko.ini found"
            $langSize = (Get-Item "./language/lang_ko.ini").Length
            Write-Host "  Size: $langSize bytes"
          } else {
            Write-Host "‚ö† lang_ko.ini NOT found - Korean language will not be available"
          }

      # Install Python dependencies
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller
          if (Test-Path "requirements.txt") {
            pip install -r requirements.txt
          }
        shell: pwsh

      # Generate version_info.txt with auto-updated version
      - name: Generate version_info.txt
        shell: pwsh
        run: |
          $version = "${{ steps.vars.outputs.version }}"
          Write-Host "Raw version: $version"
          
          $versionParts = $version -replace '-.*','' -split '\.'
          Write-Host "Version parts count: $($versionParts.Count)"
          Write-Host "Version parts: $versionParts"
          
          # Pad version to 3 parts
          while ($versionParts.Count -lt 3) {
            $versionParts += "0"
          }
          
          $v0 = [int]$versionParts[0]
          $v1 = [int]$versionParts[1]
          $v2 = [int]$versionParts[2]
          $versionStr = "$v0.$v1.$v2"
          
          Write-Host "Final version: $versionStr (v0=$v0, v1=$v1, v2=$v2)"
          
          # Build version_info.txt content as array then join
          $lines = @(
            "# UTF-8 encoding",
            "",
            "VSVersionInfo(",
            "  ffi=FixedFileInfo(",
            "    filevers=($v0, $v1, $v2, 0),",
            "    prodvers=($v0, $v1, $v2, 0),",
            "    mask=0x3f,",
            "    flags=0x0,",
            "    OS=0x40004,",
            "    fileType=0x1,",
            "    subtype=0x0,",
            "    date=(0, 0)",
            "    ),",
            "  kids=[",
            "    StringFileInfo(",
            "      [",
            "      StringTable(",
            "        u'041204B0',",
            "        [",
            "        StringStruct(u'Comments', u'Browser Bookmarks Manager'),",
            "        StringStruct(u'CompanyName', u'gloriouslegacy'),",
            "        StringStruct(u'FileDescription', u'BrowserBookmarks.exe'),",
            "        StringStruct(u'FileVersion', u'$versionStr'),",
            "        StringStruct(u'InternalName', u'BrowserBookmarks.exe'),",
            "        StringStruct(u'LegalCopyright', u'Copyright (c) 2025 gloriouslegacy'),",
            "        StringStruct(u'LegalTrademarks', u''),",
            "        StringStruct(u'OriginalFilename', u'BrowserBookmarks.exe'),",
            "        StringStruct(u'ProductName', u'BrowserBookmarks'),",
            "        StringStruct(u'ProductVersion', u'$versionStr'),",
            "        StringStruct(u'SpecialBuild', u'')",
            "        ]",
            "      )",
            "      ]",
            "    ),",
            "    VarFileInfo([VarStruct(u'Translation', [0x0412, 1200])])",
            "  ]",
            ")"
          )
          
          $lines -join "`n" | Out-File -FilePath "version_info.txt" -Encoding UTF8
          
          Write-Host "=== Generated version_info.txt ==="
          Get-Content "version_info.txt"


      # Inject version into source code
      - name: Inject Version into Source
        shell: pwsh
        run: |
          Write-Host "=== Injecting Version into winBookmarks.py ==="
          
          $version = "${{ steps.vars.outputs.version }}"
          $versionParts = $version -replace '-.*','' -split '\.'
          
          # Pad version to 3 parts
          while ($versionParts.Count -lt 3) {
            $versionParts += "0"
          }
          
          $versionStr = "$($versionParts[0]).$($versionParts[1]).$($versionParts[2])"
          Write-Host "Version to inject: $versionStr"
          
          # Read source file
          $content = Get-Content "winBookmarks.py" -Raw -Encoding UTF8
          
          # Replace CURRENT_VERSION
          $content = $content -replace 'CURRENT_VERSION = "0\.0\.0"', "CURRENT_VERSION = `"$versionStr`""
          
          # Write back
          $content | Out-File -FilePath "winBookmarks.py" -Encoding UTF8 -NoNewline
          
          Write-Host "‚úì Version injected successfully"
          
          # Verify
          $injectedLine = Get-Content "winBookmarks.py" | Select-String "CURRENT_VERSION"
          Write-Host "Verified: $injectedLine"

      # Build Updater executable
      - name: Build Updater
        shell: pwsh
        run: |
          Write-Host "=== Building Updater ==="
          
          $iconPath = "icon/icon.ico"
          
          # Build updater as windowed app 
          pyinstaller --onefile `
            --windowed `
            --name "updater" `
            --clean `
            --icon="$iconPath" `
            --version-file="version_info.txt" `
            --add-data="icon;icon" `
            updater.py
          
          if ($LASTEXITCODE -ne 0) {
            Write-Host "‚úó Updater build failed"
            exit 1
          }
          
          if (Test-Path "dist/updater.exe") {
            $size = (Get-Item "dist/updater.exe").Length
            Write-Host "‚úì Updater EXE created: $($size / 1MB) MB"
          } else {
            Write-Host "‚úó Updater EXE not found"
            exit 1
          }

      # Build Portable version
      - name: Build Portable Version
        shell: pwsh
        run: |
          Write-Host "=== Building Portable Version ==="
          
          # Create language folder if not exists
          if (-not (Test-Path "language")) {
            Write-Host "Creating language folder..."
            New-Item -ItemType Directory -Path "language" -Force
            
            # Create dummy lang_ko.ini
            "[app]" | Out-File -FilePath "language/lang_ko.ini" -Encoding UTF8
            "title = Browser Bookmarks Manager" | Out-File -FilePath "language/lang_ko.ini" -Encoding UTF8 -Append
            
            Write-Host "‚úì Language folder created"
          }
          
          $iconPath = "icon/icon.ico"
          
          # Build portable version with version info (onefile)
          pyinstaller --onefile `
            --windowed `
            --name "BrowserBookmarks" `
            --clean `
            --icon="$iconPath" `
            --version-file="version_info.txt" `
            --add-data="icon;icon" `
            --add-data="language;language" `
            winBookmarks.py
          
          if ($LASTEXITCODE -ne 0) {
            Write-Host "‚úó Portable build failed"
            exit 1
          }
          
          if (Test-Path "dist/BrowserBookmarks.exe") {
            $size = (Get-Item "dist/BrowserBookmarks.exe").Length
            Write-Host "‚úì Portable EXE created: $($size / 1MB) MB"
          } else {
            Write-Host "‚úó Portable EXE not found"
            exit 1
          }

      # Build Setup version (onedir)
      - name: Build Setup Version (onedir)
        shell: pwsh
        run: |
          Write-Host "=== Building Setup Version (onedir) ==="
          
          $iconPath = "icon/icon.ico"
          
          # Clean previous build
          if (Test-Path "build") { Remove-Item -Recurse -Force "build" }
          if (Test-Path "dist_setup") { Remove-Item -Recurse -Force "dist_setup" }
          
          # Build onedir version for Setup
          pyinstaller --onedir `
            --windowed `
            --name "BrowserBookmarks" `
            --clean `
            --icon="$iconPath" `
            --version-file="version_info.txt" `
            --distpath="dist_setup" `
            --add-data="icon;icon" `
            --add-data="language;language" `
            winBookmarks.py
          
          if ($LASTEXITCODE -ne 0) {
            Write-Host "‚úó Setup version build failed"
            exit 1
          }
          
          if (Test-Path "dist_setup/BrowserBookmarks/BrowserBookmarks.exe") {
            $folderSize = (Get-ChildItem "dist_setup/BrowserBookmarks" -Recurse | Measure-Object -Property Length -Sum).Sum / 1MB
            Write-Host "‚úì Setup version created: $([math]::Round($folderSize, 2)) MB"
          } else {
            Write-Host "‚úó Setup version not found"
            exit 1
          }

      # Install Inno Setup
      - name: Install Inno Setup
        shell: pwsh
        run: |
          Write-Host "=== Installing Inno Setup via Chocolatey ==="
          
          # Install Inno Setup using Chocolatey (pre-installed on GitHub runners)
          choco install innosetup -y
          
          # Refresh environment variables
          $env:Path = [System.Environment]::GetEnvironmentVariable("Path","Machine") + ";" + [System.Environment]::GetEnvironmentVariable("Path","User")
          
          # Verify installation
          if (Test-Path "C:\Program Files (x86)\Inno Setup 6\ISCC.exe") {
            Write-Host "‚úì Inno Setup installed successfully"
          } else {
            Write-Host "‚úó Inno Setup installation failed"
            exit 1
          }

      # Build Setup version with Inno Setup
      - name: Build Setup Version
        shell: pwsh
        run: |
          Write-Host "=== Building Setup Version ==="
          
          $version = "${{ steps.vars.outputs.version }}"
          $versionParts = $version -replace '-.*','' -split '\.'
          
          # Pad version to 3 parts
          while ($versionParts.Count -lt 3) {
            $versionParts += "0"
          }
          
          $versionStr = "$($versionParts[0]).$($versionParts[1]).$($versionParts[2])"
          
          # Create Inno Setup script
          $issScript = @"
          [Setup]
          AppName=Browser Bookmarks Manager
          AppVersion=$versionStr
          AppPublisher=gloriouslegacy
          AppPublisherURL=https://github.com/gloriouslegacy/BrowserBookmarks
          DefaultDirName={localappdata}\Programs\BrowserBookmarks
          DefaultGroupName=Browser Bookmarks Manager
          OutputDir=dist
          OutputBaseFilename=BrowserBookmarks_Setup
          Compression=lzma2
          SolidCompression=yes
          ArchitecturesInstallIn64BitMode=x64
          SetupIconFile=icon\icon.ico
          UninstallDisplayIcon={app}\BrowserBookmarks.exe
          VersionInfoVersion=$versionStr
          PrivilegesRequired=lowest
          PrivilegesRequiredOverridesAllowed=commandline
          UsePreviousAppDir=yes
          DirExistsWarning=no
          DisableProgramGroupPage=yes
          
          [Languages]
          Name: "korean"; MessagesFile: "compiler:Languages\Korean.isl"
          Name: "english"; MessagesFile: "compiler:Default.isl"
          
          [Files]
          Source: "dist_setup\BrowserBookmarks\*"; DestDir: "{app}"; Flags: ignoreversion recursesubdirs createallsubdirs
          
          [Icons]
          Name: "{group}\Browser Bookmarks Manager"; Filename: "{app}\BrowserBookmarks.exe"
          Name: "{group}\Uninstall Browser Bookmarks Manager"; Filename: "{uninstallexe}"
          Name: "{autodesktop}\Browser Bookmarks Manager"; Filename: "{app}\BrowserBookmarks.exe"; Tasks: desktopicon
          
          [Tasks]
          Name: "desktopicon"; Description: "Create a desktop icon"; GroupDescription: "Additional icons:"
          
          
          [Code]
          procedure CurStepChanged(CurStep: TSetupStep);
          var
            ResultCode: Integer;
          begin
            if CurStep = ssPostInstall then
            begin
              MsgBox('ÏóÖÎç∞Ïù¥Ìä∏Í∞Ä ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§!' + #13#10#13#10 + 'Update Complete!', mbInformation, MB_OK);
              Exec(ExpandConstant('{app}\BrowserBookmarks.exe'), '', '', SW_SHOW, ewNoWait, ResultCode);
            end;
          end;
          
          [Run]
          ; Code sectionÏóêÏÑú Ï≤òÎ¶¨ÌïòÎØÄÎ°ú Ïó¨Í∏∞Îäî ÎπÑÏõåÎë†
          "@
          
          $issScript | Out-File -FilePath "setup.iss" -Encoding UTF8
          
          # Run Inno Setup compiler
          $iscc = "C:\Program Files (x86)\Inno Setup 6\ISCC.exe"
          
          & $iscc "setup.iss"
          
          if ($LASTEXITCODE -ne 0) {
            Write-Host "‚úó Setup build failed"
            exit 1
          }
          
          if (Test-Path "dist/BrowserBookmarks_Setup.exe") {
            $size = (Get-Item "dist/BrowserBookmarks_Setup.exe").Length
            Write-Host "‚úì Setup EXE created: $($size / 1MB) MB"
          } else {
            Write-Host "‚úó Setup EXE not found"
            exit 1
          }

      # Generate file hashes
      - name: Generate File Hashes
        shell: pwsh
        run: |
          Write-Host "=== File Hashes ==="
          
          $portableHash = Get-FileHash -Path "dist/BrowserBookmarks.exe" -Algorithm SHA256
          Write-Host "Portable SHA256: $($portableHash.Hash)"
          
          $setupHash = Get-FileHash -Path "dist/BrowserBookmarks_Setup.exe" -Algorithm SHA256
          Write-Host "Setup SHA256: $($setupHash.Hash)"
          
          $updaterHash = Get-FileHash -Path "dist/updater.exe" -Algorithm SHA256
          Write-Host "Updater SHA256: $($updaterHash.Hash)"
          
          Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value @"
          ## Build Info
          
          ### Portable Version
          - SHA256: ``$($portableHash.Hash)``
          - [VirusTotal Scan](https://www.virustotal.com/gui/file/$($portableHash.Hash))
          
          ### Setup Version
          - SHA256: ``$($setupHash.Hash)``
          - [VirusTotal Scan](https://www.virustotal.com/gui/file/$($setupHash.Hash))
          
          ### Updater
          - SHA256: ``$($updaterHash.Hash)``
          "@

      # Prepare release packages
      - name: Prepare Release Packages
        shell: pwsh
        run: |
          Write-Host "=== Preparing Release Packages ==="
          
          # Create release directory
          New-Item -ItemType Directory -Force -Path "release"
          
          # Package Portable version
          Write-Host "Packaging Portable..."
          Copy-Item "dist/BrowserBookmarks.exe" "release/"
          
          # Copy updater.exe
          if (Test-Path "dist/updater.exe") {
            Copy-Item "dist/updater.exe" "release/"
            Write-Host "‚úì updater.exe added to portable package"
          }
          
          # Copy language folder to release folder for portable version
          if (Test-Path "language") {
            Copy-Item "language" "release/" -Recurse
            Write-Host "‚úì language folder added to portable package"
          }
          
          if (Test-Path "README.md") { Copy-Item "README.md" "release/README.txt" }
          if (Test-Path "LICENSE") { Copy-Item "LICENSE" "release/" }
          
          # Create README for portable
          @"
          BrowserBookmarks - Portable Version
          
          This is the portable version in a single executable file.
          
          Files included:
          - BrowserBookmarks.exe (main program)
          - updater.exe (automatic update helper - for portable version only)
          - language/ folder (language files)
          - README.txt (this file)
          
          To run:
          1. Place all files in the same folder
          2. Run BrowserBookmarks.exe
          
          Language Support:
          - Korean is built-in (default)
          - English requires language folder in the same folder as the EXE
          - To switch language: File ‚Üí Change Language ‚Üí English
          
          Settings are saved in: %APPDATA%\BrowserBookmarks\app_config.json
          
          Note: Setup installer version does not need updater.exe as it has built-in update system.
          "@ | Out-File -FilePath "release/README.txt" -Encoding UTF8
          
          Compress-Archive -Path "release/*" -DestinationPath "BrowserBookmarks_Portable.zip" -Force
          
          Write-Host "‚úì Portable package created"
          Write-Host "  Contents: BrowserBookmarks.exe, updater.exe, language folder, README.txt"
          
          Write-Host "`n=== Package Sizes ==="
          $portableSize = (Get-Item "BrowserBookmarks_Portable.zip").Length / 1MB
          Write-Host "Portable ZIP: $([math]::Round($portableSize, 2)) MB"

      # Calculate SHA256 for release assets
      - name: Calculate Release SHA256
        shell: pwsh
        run: |
          Write-Host "=== Calculating SHA256 Hashes ==="
          
          $portableHash = (Get-FileHash -Path "BrowserBookmarks_Portable.zip" -Algorithm SHA256).Hash
          $setupHash = (Get-FileHash -Path "dist/BrowserBookmarks_Setup.exe" -Algorithm SHA256).Hash
          
          Write-Host "Portable ZIP SHA256: $portableHash"
          Write-Host "Setup EXE SHA256: $setupHash"
          
          # Save hashes to environment
          "PORTABLE_SHA256=$portableHash" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8
          "SETUP_SHA256=$setupHash" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8
          
      # Create GitHub Release
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.vars.outputs.base_version }}
          name: Release ${{ steps.vars.outputs.release_name }}
          body: |
            # üì¶ Browser Bookmarks Manager v${{ steps.vars.outputs.release_name }}
            
            WindowsÏö© Î∏åÎùºÏö∞Ï†Ä Î∂ÅÎßàÌÅ¨ Î∞±ÏóÖ/Î≥µÍµ¨ ÎèÑÍµ¨
            
            ## üîê File Verification (SHA256)
            
            **Portable Version (ZIP)**
            ```
            ${{ env.PORTABLE_SHA256 }}
            ```
            
            **Setup Installer (EXE)**
            ```
            ${{ env.SETUP_SHA256 }}
            ```
            
            ## üìù Features
            
            - Edge, Chrome, Firefox Î∂ÅÎßàÌÅ¨ Î∞±ÏóÖ/Î≥µÍµ¨
            - ÏûêÎèô ÏóÖÎç∞Ïù¥Ìä∏
            - Îã§Íµ≠Ïñ¥ ÏßÄÏõê (ÌïúÍµ≠Ïñ¥, English)
            - Îã§ÌÅ¨Î™®Îìú
            - %APPDATA% ÏÑ§Ï†ï Ï†ÄÏû•
            
            ## üìù Changelog
            
            See commit history for detailed changes.

          files: |
            BrowserBookmarks_Portable.zip
            dist/BrowserBookmarks_Setup.exe
          prerelease: ${{ !startsWith(github.ref, 'refs/tags/') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}